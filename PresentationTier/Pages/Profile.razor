@page "/profile"
@using PresentationTier.Authorization;
@using PresentationTier.Data;
@using PresentationTier.Models;
@using System.Security.Claims;

@inject NavigationManager NavigationManager
@inject IPostService postService
@inject IUserService userService
@inject AuthenticationStateProvider authenticationStateProvider

<style>
    .post-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .post-card {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 5px 1px rgba(0, 0, 0, 0.1);
        font-family: "Comic Sans MS", cursive;
    }

    .title {
        font-size: 24px;
        margin-bottom: 10px;
        color: #1A3AA4;
    }

    .post-card .profile-info {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

        .post-card .profile-info .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

    .post-card .content {
        margin-bottom: 10px;
        font-size: 18px;
        color: #A4841A;
    }

    .post-card .icons {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .post-card .icons img {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-right: 10px;
        }
</style>
<PageTitle>@currentUser.Name Profile</PageTitle>
<RadzenText TextStyle="TextStyle.H5">@currentUser.Name</RadzenText>
<RadzenContentContainer>
    <RadzenCard Style="font-size: 1em; padding: 0px; border-radius: .28571429rem; width: 100%; height: 100%">
        <RadzenImage Path="https://img.freepik.com/free-vector/stylish-glowing-digital-red-lines-banner_1017-23964.jpg" Style="width: 100%; height: 300px"/>
        <RadzenCard Style="position: relative; font-size: 1em; padding: 1em; border-top: 1px solid rgba(34, 36, 38, 0.1)">
            <RadzenImage Path="https://bootdey.com/img/Content/avatar/avatar6.png" Style="max-width: 115px; min-width: 115px; min-height: 115px; max-height: 115px; display: inline-block; position: absolute; top: -75px; border-radius: 50%; border: 1px solid #ffffff"/>
            <RadzenStack Style="position: relative">
                <RadzenStack Gap="0" Style="position: relative">
                    <RadzenText TextStyle="TextStyle.Body1">@currentUser.Username</RadzenText>
                    <RadzenText Style="color: rgba(0, 0, 0, 0.4); text-decoration: none">Joined @currentUser.Joined.ToString("MMMM yyyy")</RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
    </RadzenCard>
    <RadzenTabs Visible="true" Style="margin-top: 5px">
        <Tabs>

            <RadzenTabsItem Text="Posts" Style="width: 25%">
                <RadzenStack Gap="25">
                    <RadzenCard Style="width: 75%; border-radius: 10px; max-width: 650px; min-width: 650px">
                        @foreach (var post in posts)
                        {
                            <div class="post-card">
                                <div class="profile-info">
                                    <img class="profile-pic" src="@($"data:image/png;base64,{Convert.ToBase64String(post.Picture)}")" alt="Profile Picture" />
                                    <div class="form-label">@post.PostedBy</div>
                                </div>
                                <div class="title">@post.Title</div>
                                <div class="content">@post.Content</div>
                                <div class="likes">Likes: @post.NumberOfLikes</div>
                            </div>
                        }
                    </RadzenCard>
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Reviews" Style="width: 25%">
                <RadzenStack Gap="25">
                    <RadzenCard Style="width: 75%; border-radius: 10px; max-width: 650px; min-width: 650px">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal">
                            <RadzenImage Path="https://bootdey.com/img/Content/avatar/avatar6.png" Style="width: 50px; border-radius: 50%"/>
                            <RadzenStack Gap="0">
                                <RadzenText TextStyle="TextStyle.DisplayH6">Test Review</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Test Reviewer</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                        <RadzenText Style="padding-top: 10px">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</RadzenText>
                    </RadzenCard>
                    <RadzenCard Style="width: 75%; border-radius: 10px; max-width: 650px; min-width: 650px">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal">
                            <RadzenImage Path="https://bootdey.com/img/Content/avatar/avatar6.png" Style="width: 50px; border-radius: 50%"/>
                            <RadzenStack Gap="0">
                                <RadzenText TextStyle="TextStyle.DisplayH6">Test Review</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Test Reviewer</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                        <RadzenText Style="padding-top: 10px">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</RadzenText>
                    </RadzenCard>
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Likes" Style="width: 25%">
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</RadzenContentContainer>

@code {
    public User currentUser = new User();
    private List<Post> posts = new List<Post>();

    protected override async Task OnInitializedAsync()
    {
        var email = ((CustomAuthenticationStateProvider)authenticationStateProvider).
        GetAuthenticationStateAsync().Result.User.FindFirst(claim => claim.Type.Equals(ClaimTypes.Email))?.Value;

        if (!string.IsNullOrEmpty(email))
        {
            currentUser = await userService.GetUserInfo(email);
        }

        // Fetch all posts
        posts = await postService.GetAllPosts();
        
        // Call the base OnInitializedAsync method
        await base.OnInitializedAsync();
    }
}
